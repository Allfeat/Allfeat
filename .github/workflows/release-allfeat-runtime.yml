name: Allfeat Runtime Release

on:
  push:
    tags:
      - "allfeat-*"
  workflow_dispatch:

jobs:
  release-allfeat:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Srtool build
        id: srtool_build
        uses: chevdor/srtool-actions@v0.9.2
        env:
          BUILD_OPTS: "--features on-chain-release-build"
        with:
          chain: allfeat
          runtime_dir: runtime/mainnet

      - name: Prepare artifacts
        id: prep
        run: |
          set -euo pipefail

          mkdir -p release-artifacts

          WASM_PATH="runtime/mainnet/target/srtool/release/wbuild/allfeat-runtime/allfeat_runtime.compact.compressed.wasm"
          cp "${WASM_PATH}" "release-artifacts/allfeat_runtime.compact.compressed.wasm"

          echo '${{ steps.srtool_build.outputs.json }}' > release-artifacts/srtool.json

          cat > release-artifacts/RELEASE_SUMMARY.md << 'EOF'
          # Allfeat Runtime Release

          ## Runtime
          - Version: ${{ steps.srtool_build.outputs.version }}
          - Proposal Hash: `${{ steps.srtool_build.outputs.proposal_hash }}`

          ## Srtool Info
          ${{ steps.srtool_build.outputs.info }}

          ## Srtool JSON (build metadata)
          ```json
          ${{ steps.srtool_build.outputs.json }}
          ```
          EOF

          SPEC_VERSION=$(echo '${{ steps.srtool_build.outputs.json }}' | jq -r '
            .runtime.compressed.subwasm.core_version.specVersion
          ')
          echo "$SPEC_VERSION" > release-artifacts/spec_version.txt

          echo "spec_version=$SPEC_VERSION" >> $GITHUB_OUTPUT

      - name: Upload workflow artifact (debug)
        uses: actions/upload-artifact@v4
        with:
          name: allfeat-runtime-artifacts
          path: release-artifacts

      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: Allfeat Runtime v${{ steps.prep.outputs.spec_version }}
          body: |
            # Allfeat Runtime Release

            ## Runtime
            - Git tag: `${{ github.ref_name }}`
            - Runtime version (Cargo): `${{ steps.srtool_build.outputs.version }}`
            - Runtime specVersion: `${{ steps.prep.outputs.spec_version }}`
            - Proposal hash: `${{ steps.srtool_build.outputs.proposal_hash }}`

            ## Deterministic build (srtool)
            - Info:
              ${{ steps.srtool_build.outputs.info }}

            - JSON:
              ```json
              ${{ steps.srtool_build.outputs.json }}
              ```

            ## Verification
            Built with srtool-actions@v0.9.2 and
            BUILD_OPTS="--features on-chain-release-build".

          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload assets to release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          files: |
            release-artifacts/allfeat_runtime.compact.compressed.wasm
            release-artifacts/srtool.json
            release-artifacts/RELEASE_SUMMARY.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
